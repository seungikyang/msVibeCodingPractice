@inject NavigationManager Navigation
@inject Services.ApiService ApiService
@inject Services.AuthService AuthService

<div class="post-card" @onclick="HandlePostClick">
    <div class="post-header">
        <div class="avatar"></div>
        <div class="username">@Post.Username</div>
    </div>
    
    <div class="post-content">
        <p>@Post.Content</p>
    </div>
    
    <div class="post-actions">
        <button class="action-button @(isLiked ? "liked" : "")"
                @onclick="HandleLikeToggle"
                @onclick:stopPropagation="true"
                aria-label="Like">
            @if (isLiked)
            {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor" />
                </svg>
            }
            else
            {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="none" stroke="currentColor" stroke-width="2" />
                </svg>
            }
            @if (likesCount > 0)
            {
                <span class="action-count">@likesCount</span>
            }
        </button>
        
        <button class="action-button"
                @onclick="HandleCommentClick"
                @onclick:stopPropagation="true"
                aria-label="Comment">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z" fill="currentColor" />
            </svg>
            @if (Post.CommentsCount > 0)
            {
                <span class="action-count">@Post.CommentsCount</span>
            }
        </button>
    </div>

    @if (comments.Count > 0)
    {
        <div class="comments-section">
            <div class="comments-header">
                Comments (@comments.Count)
            </div>
            @foreach (var comment in comments.Take(2))
            {
                <div class="comment-preview-item">
                    <div class="avatar avatar-sm"></div>
                    <div style="flex: 1;">
                        <div class="username username-sm">@comment.Username</div>
                        <div class="comment-text">@comment.Content</div>
                    </div>
                </div>
            }
            @if (comments.Count > 2)
            {
                <button class="view-all-comments"
                        @onclick="HandleCommentClick"
                        @onclick:stopPropagation="true">
                    View all @comments.Count comments
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public Models.Post Post { get; set; } = null!;

    private bool isLiked;
    private int likesCount;
    private List<Models.Comment> comments = new();

    protected override void OnInitialized()
    {
        isLiked = Post.IsLiked;
        likesCount = Post.LikesCount;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Post.CommentsCount > 0)
        {
            await LoadComments();
        }
    }

    private async Task LoadComments()
    {
        try
        {
            comments = await ApiService.GetCommentsAsync(Post.Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comments: {ex.Message}");
        }
    }

    private void HandlePostClick()
    {
        Navigation.NavigateTo($"/post/{Post.Id}");
    }

    private async Task HandleLikeToggle()
    {
        try
        {
            var user = await AuthService.GetUserAsync();
            if (user == null) return;

            if (isLiked)
            {
                await ApiService.UnlikePostAsync(Post.Id);
                likesCount = Math.Max(likesCount - 1, 0);
                isLiked = false;
            }
            else
            {
                var response = await ApiService.LikePostAsync(Post.Id, user.Username);
                if (response != null)
                {
                    likesCount = response.LikesCount;
                    isLiked = true;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling like: {ex.Message}");
        }
    }

    private void HandleCommentClick()
    {
        Navigation.NavigateTo($"/post/{Post.Id}");
    }
}
